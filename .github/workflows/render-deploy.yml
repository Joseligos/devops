name: ğŸš€ Deploy to Render with Smoke Tests

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  BACKEND_URL: https://devops-crud-app-backend.onrender.com
  FRONTEND_URL: https://devops-crud-app-frontend.onrender.com

jobs:
  # Pre-deployment smoke tests on current production
  pre-deploy-tests:
    name: ğŸ” Pre-Deploy Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check backend health
        run: |
          echo "ğŸ¥ Checking backend health..."
          curl -f ${{ env.BACKEND_URL }}/healthz || echo "âš ï¸  Backend might be down"

      - name: Check frontend health
        continue-on-error: true
        run: |
          echo "ğŸ¥ Checking frontend health..."
          curl -f -I ${{ env.FRONTEND_URL }} || echo "âš ï¸  Frontend might be down"

  # Trigger Render deployments
  deploy-backend:
    name: ğŸš€ Deploy Backend to Render
    needs: pre-deploy-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Render backend deployment
        if: ${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}
        run: |
          echo "ğŸš€ Triggering Render backend deployment..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}"
          echo "âœ… Backend deployment triggered"

      - name: Wait for deployment to start
        run: |
          echo "â±ï¸  Waiting 30 seconds for deployment to initialize..."
          sleep 30

      - name: Monitor deployment progress
        run: |
          echo "ğŸ“Š Monitoring deployment..."
          echo "Watch live at: https://dashboard.render.com"
          echo ""
          echo "â±ï¸  Waiting for deployment to complete (max 5 minutes)..."
          
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf ${{ env.BACKEND_URL }}/healthz > /dev/null 2>&1; then
              echo "âœ… Backend is responding!"
              break
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Backend still deploying..."
            sleep 10
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âš ï¸  Deployment timeout reached. Check Render dashboard."
            exit 1
          fi

  deploy-frontend:
    name: ğŸš€ Deploy Frontend to Render
    needs: pre-deploy-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Render frontend deployment
        if: ${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}
        run: |
          echo "ğŸš€ Triggering Render frontend deployment..."
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}"
          echo "âœ… Frontend deployment triggered"

      - name: Wait for deployment
        run: |
          echo "â±ï¸  Waiting 60 seconds for frontend deployment..."
          sleep 60

  # Post-deployment validation with real smoke tests
  post-deploy-tests:
    name: ğŸ§ª Post-Deploy Smoke Tests
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run comprehensive smoke tests on backend
        run: |
          echo ""
          echo "ğŸ§ª Running Real Smoke Tests on Render Backend"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ./scripts/smoke-tests --url ${{ env.BACKEND_URL }}

      - name: Test frontend accessibility
        continue-on-error: true
        run: |
          echo ""
          echo "ğŸ§ª Testing Frontend Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          STATUS=$(curl -s -o /dev/null -w '%{http_code}' ${{ env.FRONTEND_URL }})
          
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Frontend is accessible (HTTP $STATUS)"
          else
            echo "âš ï¸  Frontend returned HTTP $STATUS"
          fi
          
          # Check if React app loads
          if curl -s ${{ env.FRONTEND_URL }} | grep -q "root"; then
            echo "âœ… React root element found"
          else
            echo "âš ï¸  React root element not found"
          fi

      - name: Performance test
        run: |
          echo ""
          echo "ğŸ“Š Performance Tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Test backend response time
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' ${{ env.BACKEND_URL }}/healthz)
          echo "Backend /healthz response time: ${RESPONSE_TIME}s"
          
          if (( $(echo "$RESPONSE_TIME < 2.0" | bc -l) )); then
            echo "âœ… Response time acceptable"
          else
            echo "âš ï¸  Response time high (>${RESPONSE_TIME}s)"
          fi

      - name: Integration test (Backend + Frontend)
        continue-on-error: true
        run: |
          echo ""
          echo "ğŸ”— Integration Tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Test that frontend can reach backend
          echo "Testing backend API from GitHub Actions..."
          
          # Create a test user
          TEST_USER='{"name":"github-actions-test-'$RANDOM'","email":"test@example.com"}'
          RESPONSE=$(curl -s -X POST ${{ env.BACKEND_URL }}/users \
            -H "Content-Type: application/json" \
            -d "$TEST_USER")
          
          if echo "$RESPONSE" | grep -q "id"; then
            echo "âœ… Backend API is working (user created)"
          else
            echo "âš ï¸  Backend API issue: $RESPONSE"
          fi

  # Final deployment report
  deployment-report:
    name: ğŸ“Š Deployment Report
    needs: post-deploy-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate deployment report
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Render Deployment Report"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ¯ Deployment Summary:"
          echo "  â€¢ Backend URL: ${{ env.BACKEND_URL }}"
          echo "  â€¢ Frontend URL: ${{ env.FRONTEND_URL }}"
          echo "  â€¢ Status: ${{ needs.post-deploy-tests.result }}"
          echo ""
          echo "âœ… Completed Steps:"
          echo "  1. Pre-deployment health checks"
          echo "  2. Triggered Render deployments"
          echo "  3. Monitored deployment progress"
          echo "  4. Executed smoke tests"
          echo "  5. Validated integration"
          echo ""
          echo "ğŸ“ Next Steps:"
          echo "  â€¢ Monitor in Grafana Cloud"
          echo "  â€¢ Check logs in Render dashboard"
          echo "  â€¢ Verify metrics in Prometheus"
          echo ""
          echo "ğŸ”— Useful Links:"
          echo "  â€¢ Render Dashboard: https://dashboard.render.com"
          echo "  â€¢ Backend: ${{ env.BACKEND_URL }}"
          echo "  â€¢ Frontend: ${{ env.FRONTEND_URL }}"
          echo "  â€¢ Metrics: ${{ env.BACKEND_URL }}/metrics"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Notify on failure
        if: ${{ needs.post-deploy-tests.result == 'failure' }}
        run: |
          echo "âŒ DEPLOYMENT VALIDATION FAILED"
          echo ""
          echo "âš ï¸  Action Required:"
          echo "  1. Check Render dashboard for deployment logs"
          echo "  2. Review GitHub Actions logs above"
          echo "  3. Consider rolling back if issues persist"
          echo ""
          echo "ğŸ”™ Rollback Instructions:"
          echo "  â€¢ Go to Render dashboard"
          echo "  â€¢ Select your service"
          echo "  â€¢ Click 'Rollback' to previous deployment"
