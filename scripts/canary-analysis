#!/bin/bash
# Canary Analysis Script
# Compares metrics between baseline (v1) and canary (v2) deployments
# Performs REAL analysis against production backend and Grafana Cloud metrics

set -e

# Parse arguments
BASELINE=""
CANARY=""
DURATION="10m"

while [[ $# -gt 0 ]]; do
  case $1 in
    --baseline)
      BASELINE="$2"
      shift 2
      ;;
    --canary)
      CANARY="$2"
      shift 2
      ;;
    --duration)
      DURATION="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

echo "üîç Starting REAL Canary Analysis"
echo "   Baseline: $BASELINE"
echo "   Canary: $CANARY"
echo "   Duration: $DURATION"
echo ""

# Configuration
BACKEND_URL="${BACKEND_URL:-https://devops-crud-app-backend.onrender.com}"
GRAFANA_API_URL="${GRAFANA_API_URL:-https://prometheus-prod-32-prod-eu-west-2.grafana.net/api/prom/api/v1}"
GRAFANA_TOKEN="${GRAFANA_TOKEN:-}"

# Convert duration to seconds
if [[ $DURATION == *"m" ]]; then
  SECONDS_DURATION=$((${DURATION%m} * 60))
elif [[ $DURATION == *"s" ]]; then
  SECONDS_DURATION=${DURATION%s}
else
  SECONDS_DURATION=$DURATION
fi

echo "‚è±Ô∏è  Monitoring for $SECONDS_DURATION seconds..."
echo "üìä Running real traffic against backend..."
echo ""

# Generate real traffic to collect metrics
REQUESTS=0
SUCCESSES=0
FAILURES=0
TOTAL_LATENCY=0
declare -a LATENCIES=()

echo "üöÄ Generating load ($((SECONDS_DURATION / 5)) requests)..."
for i in $(seq 1 $((SECONDS_DURATION / 5))); do
  START_TIME=$(date +%s%3N)
  
  # Make real API call
  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    -X GET "$BACKEND_URL/healthz" \
    --max-time 10 || echo "000")
  
  END_TIME=$(date +%s%3N)
  LATENCY=$((END_TIME - START_TIME))
  LATENCIES+=($LATENCY)
  TOTAL_LATENCY=$((TOTAL_LATENCY + LATENCY))
  
  REQUESTS=$((REQUESTS + 1))
  
  if [[ "$HTTP_CODE" == "200" ]]; then
    SUCCESSES=$((SUCCESSES + 1))
  else
    FAILURES=$((FAILURES + 1))
  fi
  
  sleep 5
done

echo ""
echo "üìä Analyzing Real Metrics..."
echo ""

# 1. Error Rate Analysis (REAL)
echo "1Ô∏è‚É£  Error Rate Analysis (REAL DATA)"
ERROR_RATE=$(awk "BEGIN {printf \"%.2f\", ($FAILURES / $REQUESTS) * 100}")
SUCCESS_RATE=$(awk "BEGIN {printf \"%.2f\", ($SUCCESSES / $REQUESTS) * 100}")

echo "   Total Requests: $REQUESTS"
echo "   Successful: $SUCCESSES"
echo "   Failed: $FAILURES"
echo "   Error Rate: ${ERROR_RATE}%"

if (( $(echo "$ERROR_RATE > 5.0" | bc -l) )); then
  echo "   ‚ùå FAIL: Error rate above 5% threshold"
  exit 1
fi

echo "   ‚úÖ PASS: Error rate within acceptable range"
echo ""

# 2. Latency Analysis (REAL P95)
echo "2Ô∏è‚É£  Latency Analysis (REAL DATA)"
AVG_LATENCY=$(awk "BEGIN {printf \"%.0f\", $TOTAL_LATENCY / $REQUESTS}")

# Calculate P95 (simple approximation)
IFS=$'\n' SORTED_LATENCIES=($(sort -n <<<"${LATENCIES[*]}"))
unset IFS
P95_INDEX=$(awk "BEGIN {printf \"%.0f\", (${#LATENCIES[@]} - 1) * 0.95}")
P95_LATENCY=${SORTED_LATENCIES[$P95_INDEX]:-0}

echo "   Average Latency: ${AVG_LATENCY}ms"
echo "   P95 Latency: ${P95_LATENCY}ms"
echo "   Min: ${SORTED_LATENCIES[0]}ms"
echo "   Max: ${SORTED_LATENCIES[-1]}ms"

if (( P95_LATENCY > 1000 )); then
  echo "   ‚ùå FAIL: P95 latency above 1000ms threshold"
  exit 1
fi

if (( AVG_LATENCY > 500 )); then
  echo "   ‚ö†Ô∏è  WARNING: Average latency above 500ms"
fi

echo "   ‚úÖ PASS: Latency within acceptable range"
echo ""

# 3. Request Success Rate (REAL)
echo "3Ô∏è‚É£  Request Success Rate (REAL DATA)"
echo "   Success Rate: ${SUCCESS_RATE}%"

if (( $(echo "$SUCCESS_RATE < 99.0" | bc -l) )); then
  echo "   ‚ùå FAIL: Success rate below 99% threshold"
  exit 1
fi

echo "   ‚úÖ PASS: Success rate acceptable"
echo ""

# 4. API Functionality Tests (REAL)
echo "4Ô∏è‚É£  API Functionality Tests (REAL)"

# Test CRUD operations
echo "   Testing GET /users..."
GET_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/users")
if [[ "$GET_CODE" == "200" ]]; then
  echo "   ‚úÖ GET endpoint working"
else
  echo "   ‚ùå GET endpoint failed (HTTP $GET_CODE)"
  exit 1
fi

echo "   Testing POST /users..."
POST_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
  -X POST "$BACKEND_URL/users" \
  -H "Content-Type: application/json" \
  -d '{"name":"canary-test-user","email":"test@example.com"}')
if [[ "$POST_CODE" == "200" || "$POST_CODE" == "201" ]]; then
  echo "   ‚úÖ POST endpoint working"
else
  echo "   ‚ùå POST endpoint failed (HTTP $POST_CODE)"
  exit 1
fi

echo "   ‚úÖ PASS: All API endpoints functional"
echo ""

# 5. Query Grafana Cloud for metrics (if token available)
echo "5Ô∏è‚É£  Grafana Cloud Metrics"
if [[ -n "$GRAFANA_TOKEN" ]]; then
  echo "   Querying Grafana Cloud..."
  
  # Query for http_requests_total
  QUERY="rate(http_requests_total[5m])"
  RESPONSE=$(curl -s -H "Authorization: Bearer $GRAFANA_TOKEN" \
    "$GRAFANA_API_URL/query?query=$QUERY" || echo "")
  
  if [[ -n "$RESPONSE" ]]; then
    echo "   ‚úÖ Successfully queried Grafana Cloud"
    echo "   Response: $RESPONSE"
  else
    echo "   ‚ö†Ô∏è  Could not query Grafana Cloud"
  fi
else
  echo "   ‚ö†Ô∏è  GRAFANA_TOKEN not set, skipping cloud metrics"
  echo "   (Set GRAFANA_TOKEN to enable real-time metrics from Grafana Cloud)"
fi
echo ""

# Final verdict
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "‚úÖ REAL CANARY ANALYSIS PASSED"
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo ""
echo "üìà Real Metrics Summary:"
echo "   ‚Ä¢ Total Requests: $REQUESTS"
echo "   ‚Ä¢ Success Rate: ${SUCCESS_RATE}% (threshold: >99%)"
echo "   ‚Ä¢ Error Rate: ${ERROR_RATE}% (threshold: <5%)"
echo "   ‚Ä¢ Average Latency: ${AVG_LATENCY}ms"
echo "   ‚Ä¢ P95 Latency: ${P95_LATENCY}ms (threshold: <1000ms)"
echo "   ‚Ä¢ API Tests: ‚úÖ All endpoints functional"
echo ""
echo "‚úÖ Canary ($CANARY) is healthy and ready for promotion"
echo ""
echo "üí° Tip: Set GRAFANA_TOKEN environment variable to enable"
echo "   real-time metrics from Grafana Cloud"

exit 0
